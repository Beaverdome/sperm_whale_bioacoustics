---

title: Data preparation

keywords: fastai
sidebar: home_sidebar

summary: "Downloading the data and developing the machinery for feeding it to our models"
description: "Downloading the data and developing the machinery for feeding it to our models"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 02_Data_preparation.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>fastai</code> library provides the very flexible mechanism of the DataBlock API. This should generally be our main goto tool when working with data in non-standard formats.</p>
<p>As fastai v2 is a new version of the library and we have little experience with it, we decided to first drop down to using the mid-level API. This is to ensure we have full control over data processing and to learn how to write custom transforms (we will need this to run some of the experiments we have planned). Once we complete the deepdive into how data is handled by the <code>fastai</code> library, hopefully we will be able to utilize the lessons we learn and use the higher level DataBlock API.</p>
<p>Let's download the data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>wget https://static-content.springer.com/esm/art%3A10.1038%2Fs41598-019-48909-4/MediaObjects/41598_2019_48909_MOESM2_ESM.xlsx -O data/Dominicana.xlsx
<span class="o">!</span>wget https://static-content.springer.com/esm/art%3A10.1038%2Fs41598-019-48909-4/MediaObjects/41598_2019_48909_MOESM3_ESM.xlsx -O data/ETP.xlsx
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>--2020-03-06 15:23:40--  https://static-content.springer.com/esm/art%3A10.1038%2Fs41598-019-48909-4/MediaObjects/41598_2019_48909_MOESM2_ESM.xlsx
Resolving static-content.springer.com (static-content.springer.com)... 151.101.192.95, 151.101.128.95, 151.101.64.95, ...
Connecting to static-content.springer.com (static-content.springer.com)|151.101.192.95|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 867711 (847K) [application/octet-stream]
Saving to: ‘data/Dominicana.xlsx’

data/Dominicana.xls 100%[===================&gt;] 847.37K  3.71MB/s    in 0.2s    

2020-03-06 15:23:41 (3.71 MB/s) - ‘data/Dominicana.xlsx’ saved [867711/867711]

--2020-03-06 15:23:41--  https://static-content.springer.com/esm/art%3A10.1038%2Fs41598-019-48909-4/MediaObjects/41598_2019_48909_MOESM3_ESM.xlsx
Resolving static-content.springer.com (static-content.springer.com)... 151.101.192.95, 151.101.128.95, 151.101.64.95, ...
Connecting to static-content.springer.com (static-content.springer.com)|151.101.192.95|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1753245 (1.7M) [application/octet-stream]
Saving to: ‘data/ETP.xlsx’

data/ETP.xlsx       100%[===================&gt;]   1.67M  3.88MB/s    in 0.4s    

2020-03-06 15:23:41 (3.88 MB/s) - ‘data/ETP.xlsx’ saved [1753245/1753245]

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="First-look-at-the-data">First look at the data<a class="anchor-link" href="#First-look-at-the-data"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And this is what the data looks like. It contains the ICI information (independent variables) as well as labels, such as Coda type or Clan membership.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dominicana</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>codaNUM2018</th>
      <th>Date</th>
      <th>nClicks</th>
      <th>Duration</th>
      <th>ICI1</th>
      <th>ICI2</th>
      <th>ICI3</th>
      <th>ICI4</th>
      <th>ICI5</th>
      <th>ICI6</th>
      <th>ICI7</th>
      <th>ICI8</th>
      <th>ICI9</th>
      <th>CodaType</th>
      <th>Clan</th>
      <th>Unit</th>
      <th>UnitNum</th>
      <th>IDN</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2005-03-04 00:00:00</td>
      <td>5</td>
      <td>1.188</td>
      <td>0.293</td>
      <td>0.282</td>
      <td>0.298</td>
      <td>0.315</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5R3</td>
      <td>EC1</td>
      <td>A</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>2005-03-04 00:00:00</td>
      <td>5</td>
      <td>1.125</td>
      <td>0.287</td>
      <td>0.265</td>
      <td>0.299</td>
      <td>0.274</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5R3</td>
      <td>EC1</td>
      <td>A</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>2005-03-04 00:00:00</td>
      <td>5</td>
      <td>1.090</td>
      <td>0.264</td>
      <td>0.253</td>
      <td>0.297</td>
      <td>0.276</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5R3</td>
      <td>EC1</td>
      <td>A</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>2005-03-04 00:00:00</td>
      <td>5</td>
      <td>1.090</td>
      <td>0.269</td>
      <td>0.265</td>
      <td>0.271</td>
      <td>0.285</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5R3</td>
      <td>EC1</td>
      <td>A</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>2005-03-04 00:00:00</td>
      <td>5</td>
      <td>1.101</td>
      <td>0.273</td>
      <td>0.267</td>
      <td>0.266</td>
      <td>0.295</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5R3</td>
      <td>EC1</td>
      <td>A</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">etp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CodaNum</th>
      <th>FullDateTime</th>
      <th>ClanNum</th>
      <th>ClanName</th>
      <th>NumClicks</th>
      <th>TotalDur</th>
      <th>ICI1</th>
      <th>ICI2</th>
      <th>ICI3</th>
      <th>ICI4</th>
      <th>ICI5</th>
      <th>ICI6</th>
      <th>ICI7</th>
      <th>ICI8</th>
      <th>ICI9</th>
      <th>ICI10</th>
      <th>ICI11</th>
      <th>Coda Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>02/23/1985 12:03:01</td>
      <td>1.0</td>
      <td>Regular</td>
      <td>5</td>
      <td>0.531</td>
      <td>0.141</td>
      <td>0.127</td>
      <td>0.126</td>
      <td>0.138</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>599.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>02/23/1985 12:03:03</td>
      <td>1.0</td>
      <td>Regular</td>
      <td>5</td>
      <td>0.526</td>
      <td>0.132</td>
      <td>0.128</td>
      <td>0.124</td>
      <td>0.143</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>599.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>02/23/1985 12:03:06</td>
      <td>1.0</td>
      <td>Regular</td>
      <td>5</td>
      <td>0.491</td>
      <td>0.134</td>
      <td>0.129</td>
      <td>0.118</td>
      <td>0.109</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>599.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>02/23/1985 12:03:07</td>
      <td>1.0</td>
      <td>Regular</td>
      <td>8</td>
      <td>1.411</td>
      <td>0.204</td>
      <td>0.194</td>
      <td>0.218</td>
      <td>0.202</td>
      <td>0.207</td>
      <td>0.206</td>
      <td>0.18</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>899.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>02/23/1985 12:03:09</td>
      <td>1.0</td>
      <td>Regular</td>
      <td>5</td>
      <td>0.528</td>
      <td>0.133</td>
      <td>0.129</td>
      <td>0.130</td>
      <td>0.137</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>599.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-for-pretraining">Data for pretraining<a class="anchor-link" href="#Data-for-pretraining"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's construct our dataset step by step. A <code>TfmdLists</code> object is able to read the rows ouf our DataFrame and treat them as items (<code>item</code> is the name for an example in the <code>fastai</code> parlance).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfmd_lists</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">dominicana</span><span class="p">,</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfmd_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>codaNUM2018                      1
Date           2005-03-04 00:00:00
nClicks                          5
Duration                     1.188
ICI1                         0.293
ICI2                         0.282
ICI3                         0.298
ICI4                         0.315
ICI5                             0
ICI6                             0
ICI7                             0
ICI8                             0
ICI9                             0
CodaType                       5R3
Clan                           EC1
Unit                             A
UnitNum                          1
IDN                              0
Name: 0, dtype: object</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">tfmd_lists</span><span class="p">),</span> <span class="n">dominicana</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(8719, 8719)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Looking good. Let's see if we can extract the ICI information from a single row and package it in a way that would be suitable for our model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_independent_vars" class="doc_header"><code>get_independent_vars</code><a href="https://github.com/fastai/sperm_whale_bioacoustics/tree/master/sperm_whale_bioacoustics/data.py#L14" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_independent_vars</code>(<strong><code>row</code></strong>, <strong><code>start_col</code></strong>=<em><code>4</code></em>, <strong><code>n_vals</code></strong>=<em><code>9</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">get_independent_vars</span><span class="p">(</span><span class="n">dominicana</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([0.   , 0.   , 0.   , 0.   , 0.   , 0.293, 0.282, 0.298, 0.315])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This looks good. Can we use this in <code>TfmdLists</code>?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfmd_lists</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">dominicana</span><span class="p">,</span> <span class="p">[</span><span class="n">get_independent_vars</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfmd_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([0.   , 0.   , 0.   , 0.   , 0.   , 0.293, 0.282, 0.298, 0.315])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For the pretraining, we can go directly from this representation to the targets (the target being the last ICI)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="independent_vars_to_targs" class="doc_header"><code>independent_vars_to_targs</code><a href="https://github.com/fastai/sperm_whale_bioacoustics/tree/master/sperm_whale_bioacoustics/data.py#L21" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>independent_vars_to_targs</code>(<strong><code>ary</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfmd_lists</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">dominicana</span><span class="p">,</span> <span class="p">[</span><span class="n">get_independent_vars</span><span class="p">,</span> <span class="n">independent_vars_to_targs</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfmd_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.315</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We now need to make sure that the independent variables, our train data, doesn't contain the targets.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="drop_last_value" class="doc_header"><code>drop_last_value</code><a href="https://github.com/fastai/sperm_whale_bioacoustics/tree/master/sperm_whale_bioacoustics/data.py#L24" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>drop_last_value</code>(<strong><code>ary</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We would like each example to be represented as a tuple of <code>(independent_variables, targets)</code>. In order to arrive at this representation, we can run two transformation pipelines in parallel.</p>
<p>One transformation pipeline will give us the independent variables:</p>
<p><code>TfmdLists(dominicana, [get_independent_vars, drop_last_value])</code></p>
<p>and the other will give us the dependent variable, our target:</p>
<p><code>TfmdLists(dominicana, [get_independent_vars, independent_vars_to_targs])</code></p>
<p>The fastai class that can wrap multiple transformation pipelines is called <code>Datasets</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">dominicana</span><span class="p">,</span> <span class="p">[[</span><span class="n">get_independent_vars</span><span class="p">,</span> <span class="n">drop_last_value</span><span class="p">],</span> <span class="p">[</span><span class="n">get_independent_vars</span><span class="p">,</span> <span class="n">independent_vars_to_targs</span><span class="p">]]);</span> <span class="n">datasets</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#8719) [(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.293, 0.282, 0.298]), 0.315),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.287, 0.265, 0.299]), 0.274),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.264, 0.253, 0.297]), 0.276),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.269, 0.265, 0.271]), 0.285),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.273, 0.267, 0.266]), 0.295),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.278, 0.27 , 0.269]), 0.271),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.269, 0.293, 0.287]), 0.289),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.279, 0.277, 0.28 ]), 0.294),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.284, 0.278, 0.28 ]), 0.29),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.297, 0.277, 0.275]), 0.283)...]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.293, 0.282, 0.298]), 0.315)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is looking good. We have the data for pretraining ready. But what about actual training? Here we will need labels transformed in a way suitable for our model to learn from.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-for-training">Data for training<a class="anchor-link" href="#Data-for-training"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We specify the first pipeline as follows:
<code>TfmdLists(dominicana, [get_independent_vars])</code></p>
<p>For the second pipeline however, we will need new functionality we have not developed yet. We would like to be able to specify a set of labels as targets (this could be clan membership or coda type for instance).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_target" class="doc_header"><code>get_target</code><a href="https://github.com/fastai/sperm_whale_bioacoustics/tree/master/sperm_whale_bioacoustics/data.py#L27" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_target</code>(<strong><code>row</code></strong>, <strong><code>col_name</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfmd_lists</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">dominicana</span><span class="p">,</span> <span class="p">[</span><span class="n">get_clan_membership</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfmd_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;EC1&#39;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dominicana</span><span class="o">.</span><span class="n">Clan</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([&#39;EC1&#39;, &#39;EC2&#39;], dtype=object)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can now extract the clan name as a string, but this is not a representation we can train our model on. We need to go from string labels to a set of indexes.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Categorize</span><span class="p">(</span><span class="n">vocab</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EC1&#39;</span><span class="p">,</span> <span class="s1">&#39;EC2&#39;</span><span class="p">])(</span><span class="s1">&#39;EC1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TensorCategory(0)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This does the trick!</p>
<p>Let's now pull all this into a <code>Datasets</code> object.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">dominicana</span><span class="p">,</span> <span class="p">[[</span><span class="n">get_independent_vars</span><span class="p">],</span> <span class="p">[</span><span class="n">get_clan_membership</span><span class="p">,</span> <span class="n">Categorize</span><span class="p">]]);</span> <span class="n">datasets</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#8719) [(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.293, 0.282, 0.298, 0.315]), TensorCategory(0)),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.287, 0.265, 0.299, 0.274]), TensorCategory(0)),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.264, 0.253, 0.297, 0.276]), TensorCategory(0)),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.269, 0.265, 0.271, 0.285]), TensorCategory(0)),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.273, 0.267, 0.266, 0.295]), TensorCategory(0)),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.278, 0.27 , 0.269, 0.271]), TensorCategory(0)),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.269, 0.293, 0.287, 0.289]), TensorCategory(0)),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.279, 0.277, 0.28 , 0.294]), TensorCategory(0)),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.284, 0.278, 0.28 , 0.29 ]), TensorCategory(0)),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.297, 0.277, 0.275, 0.283]), TensorCategory(0))...]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>Datasets</code> class can work with the <code>Categorize</code> transform to initialize it without us having to explicitly pass the vocab (it creates the vocab from the data we provide it).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">datasets</span><span class="o">.</span><span class="n">tfms</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vocab</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#2) [&#39;EC1&#39;,&#39;EC2&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We now have everything we need on the data side to reproduce the RNN experiments from the paper. Let us now see if we can use the DataBlock API to nicely package it all up.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Using-the-DataBlock-API">Using the DataBlock API<a class="anchor-link" href="#Using-the-DataBlock-API"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For the pretraining, we can use all the data we have across the two datasets (the Dominica and Eastern Tropical Pacific (ETP) datasets). Let's concatenate them together.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">merged_datasets</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CodaNum</th>
      <th>FullDateTime</th>
      <th>ClanNum</th>
      <th>ClanName</th>
      <th>NumClicks</th>
      <th>TotalDur</th>
      <th>ICI1</th>
      <th>ICI2</th>
      <th>ICI3</th>
      <th>ICI4</th>
      <th>ICI5</th>
      <th>ICI6</th>
      <th>ICI7</th>
      <th>ICI8</th>
      <th>ICI9</th>
      <th>ICI10</th>
      <th>ICI11</th>
      <th>Coda Type</th>
      <th>codaNUM2018</th>
      <th>Date</th>
      <th>nClicks</th>
      <th>Duration</th>
      <th>CodaType</th>
      <th>Clan</th>
      <th>Unit</th>
      <th>UnitNum</th>
      <th>IDN</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.0</td>
      <td>02/23/1985 12:03:01</td>
      <td>1.0</td>
      <td>Regular</td>
      <td>5.0</td>
      <td>0.531</td>
      <td>0.141</td>
      <td>0.127</td>
      <td>0.126</td>
      <td>0.138</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>599.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2.0</td>
      <td>02/23/1985 12:03:03</td>
      <td>1.0</td>
      <td>Regular</td>
      <td>5.0</td>
      <td>0.526</td>
      <td>0.132</td>
      <td>0.128</td>
      <td>0.124</td>
      <td>0.143</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>599.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3.0</td>
      <td>02/23/1985 12:03:06</td>
      <td>1.0</td>
      <td>Regular</td>
      <td>5.0</td>
      <td>0.491</td>
      <td>0.134</td>
      <td>0.129</td>
      <td>0.118</td>
      <td>0.109</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>599.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4.0</td>
      <td>02/23/1985 12:03:07</td>
      <td>1.0</td>
      <td>Regular</td>
      <td>8.0</td>
      <td>1.411</td>
      <td>0.204</td>
      <td>0.194</td>
      <td>0.218</td>
      <td>0.202</td>
      <td>0.207</td>
      <td>0.206</td>
      <td>0.18</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>899.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5.0</td>
      <td>02/23/1985 12:03:09</td>
      <td>1.0</td>
      <td>Regular</td>
      <td>5.0</td>
      <td>0.528</td>
      <td>0.133</td>
      <td>0.129</td>
      <td>0.130</td>
      <td>0.137</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>599.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let us craft a DataBlock that will read in the data</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trainable_params</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#25714) [(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.531, 0.141, 0.127,
       0.126]), 0.138),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.526, 0.132, 0.128,
       0.124]), 0.143),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.491, 0.134, 0.129,
       0.118]), 0.109),(array([0.   , 0.   , 0.   , 1.411, 0.204, 0.194, 0.218, 0.202, 0.207,
       0.206]), 0.18),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.528, 0.133, 0.129,
       0.13 ]), 0.137),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.538, 0.138, 0.133,
       0.127]), 0.14),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.534, 0.131, 0.137,
       0.128]), 0.137),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.549, 0.148, 0.135,
       0.127]), 0.139),(array([0.   , 0.   , 0.   , 1.032, 0.148, 0.147, 0.139, 0.142, 0.149,
       0.144]), 0.162),(array([0.   , 0.   , 0.   , 0.   , 0.   , 0.709, 0.148, 0.133, 0.132,
       0.135]), 0.16)...]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is looking good. As for the train data, situation is a bit more complex - we need to align how we create our datasets with the paper.</p>
<p>It seems that due to lack of data whale identification was only evaluated on train set. Since this gives us little insights into how the model would generalize to unseen data, let us not include this in our analysis.</p>
<p>With regards to the "coda type classification" task, the paper reports training on 23 coda types from the Dominicana dataset and 43 coda types from the ETP dataset. The authors were very kind to share their <a href="https://github.com/dgruber212/Sperm_Whale_Machine_Learning/blob/master/RNNClassifier.py">code on github</a> and we can align how we create our datasets with them.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dominicana</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>codaNUM2018</th>
      <th>Date</th>
      <th>nClicks</th>
      <th>Duration</th>
      <th>ICI1</th>
      <th>ICI2</th>
      <th>ICI3</th>
      <th>ICI4</th>
      <th>ICI5</th>
      <th>ICI6</th>
      <th>ICI7</th>
      <th>ICI8</th>
      <th>ICI9</th>
      <th>CodaType</th>
      <th>Clan</th>
      <th>Unit</th>
      <th>UnitNum</th>
      <th>IDN</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2005-03-04 00:00:00</td>
      <td>5</td>
      <td>1.188</td>
      <td>0.293</td>
      <td>0.282</td>
      <td>0.298</td>
      <td>0.315</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5R3</td>
      <td>EC1</td>
      <td>A</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>2005-03-04 00:00:00</td>
      <td>5</td>
      <td>1.125</td>
      <td>0.287</td>
      <td>0.265</td>
      <td>0.299</td>
      <td>0.274</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5R3</td>
      <td>EC1</td>
      <td>A</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>2005-03-04 00:00:00</td>
      <td>5</td>
      <td>1.090</td>
      <td>0.264</td>
      <td>0.253</td>
      <td>0.297</td>
      <td>0.276</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5R3</td>
      <td>EC1</td>
      <td>A</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>2005-03-04 00:00:00</td>
      <td>5</td>
      <td>1.090</td>
      <td>0.269</td>
      <td>0.265</td>
      <td>0.271</td>
      <td>0.285</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5R3</td>
      <td>EC1</td>
      <td>A</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>2005-03-04 00:00:00</td>
      <td>5</td>
      <td>1.101</td>
      <td>0.273</td>
      <td>0.267</td>
      <td>0.266</td>
      <td>0.295</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5R3</td>
      <td>EC1</td>
      <td>A</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dominicana_clean</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(8032, 18)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dominicana_clean</span><span class="o">.</span><span class="n">CodaType</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>23</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For the ETP dataset, unfortunately the preprocessing code is not in the repository. Based on the information in the paper, we were unable to infer how exactly the data was processed.</p>
<p>We will only use the Dominicana dataset for our experiments. This might actually be advantageous - the intent behind this repository is open the reaserch field to a broader audience and to evaluate the performance of Random Forests. As such, narrowing down the scope of our inquiry in terms of data we run our experiments on might be beneficial.</p>
<p>If our preliminary results will be promising, maybe someone else will chose to run experiments on a broader set of data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dblock_train</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">get_x</span> <span class="o">=</span> <span class="n">get_independent_vars</span><span class="p">,</span>
    <span class="n">get_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_clan_membership</span><span class="p">,</span> <span class="n">Categorize</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}
</div>
 

